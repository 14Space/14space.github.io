<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Играть с ботом — Chess Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="ChessLogo.jpg" type="image/jpg">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/chessboard-1.0.0.min.css">
  <link rel="stylesheet" href="css/bot.css" />
</head>
<body class="page">
    <a href="index.html" class="back-link">
        ← На главную
    </a>
    <main class="content">
        <div id="game-area" style="display: none;">
            <div class="game-container">
                <div class="advantage-bar-container">
                    <div class="advantage-bar" id="advantage-bar"></div>
                    <div class="advantage-text" id="advantage-text"></div>
                </div>
                <div id="board" style="width: 500px"></div>
            </div>
            <div id="status"></div>
        </div>
        <div id="player-choice" class="player-choice-container">
            <h1>Выберите сторону</h1>
            <button id="white-button">Играть за белых</button>
            <button id="black-button">Играть за чёрных</button>
        </div>
    </main>

    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/chessboard-1.0.0.min.js"></script>
    <script src="js/chess.min.js"></script>
    <script src="js/stockfish.js"></script>

    <script>
      var board = null;
      var game = new Chess();
      var stockfish = new Worker('js/stockfish.js');
      var statusDiv = document.getElementById('status');
      var advantageBar = document.getElementById('advantage-bar');
      var advantageText = document.getElementById('advantage-text');
      var whiteButton = document.getElementById('white-button');
      var blackButton = document.getElementById('black-button');
      var gameArea = document.getElementById('game-area');
      var playerColor = 'w';

      var pieceValues = {
          'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 0,
          'P': 1, 'N': 3, 'B': 3, 'R': 5, 'Q': 9, 'K': 0
      };

      function calculateMaterialAdvantage() {
          var whitePieces = 0;
          var blackPieces = 0;
          var whiteScore = 0;
          var blackScore = 0;
          var fen = game.fen().split(' ')[0];
          
          for (var i = 0; i < fen.length; i++) {
              var piece = fen[i];
              if (piece === '/') continue; 

              if (!isNaN(parseInt(piece))) {
                  continue;
              }
              
              if (piece.toUpperCase() === piece) { 
                  whiteScore += pieceValues[piece];
                  whitePieces++;
              } else { 
                  blackScore += pieceValues[piece];
                  blackPieces++;
              }
          }
          
          if (whitePieces === 1) {
              advantageText.innerText = `-${blackScore}`;
              advantageBar.style.height = `0%`;
              advantageBar.style.backgroundColor = '#624128';
              return;
          }

          if (blackPieces === 1) {
              advantageText.innerText = `+${whiteScore}`;
              advantageBar.style.height = `100%`;
              advantageBar.style.backgroundColor = '#d18b47';
              return;
          }

          var advantage = whiteScore - blackScore;
          var absAdvantage = Math.abs(advantage);
          var barHeight = 50 + (advantage / 30) * 50; 
          barHeight = Math.max(0, Math.min(100, barHeight));

          if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material()) {
              advantageText.innerText = '0';
              advantageBar.style.height = '50%';
              advantageBar.style.backgroundColor = '#8c7052';
              return;
          }
          
          if (advantage > 0) {
              advantageText.innerText = `+${absAdvantage}`;
              advantageBar.style.height = `${barHeight}%`;
              advantageBar.style.backgroundColor = '#d18b47';
          } else if (advantage < 0) {
              advantageText.innerText = `-${absAdvantage}`;
              advantageBar.style.height = `${barHeight}%`;
              advantageBar.style.backgroundColor = '#624128';
          } else {
              advantageText.innerText = '0';
              advantageBar.style.height = '50%';
              advantageBar.style.backgroundColor = '#8c7052';
          }
      }

      function updateStatus() {
          var status = '';

          if (game.in_checkmate()) {
              status = 'Мат!';
              if ((game.turn() === 'w' && playerColor === 'w') || (game.turn() === 'b' && playerColor === 'b')) {
                  status += ' Вы проиграли!';
              } else {
                  status += ' Вы победили!';
              }
          } else if (game.in_draw() || game.in_stalemate() || game.in_threefold_repetition() || game.insufficient_material()) {
              status = 'Ничья';
          } else {
              if (game.in_check()) {
                  if ((game.turn() === 'w' && playerColor === 'w') || (game.turn() === 'b' && playerColor === 'b')) {
                      status = 'Вам шах!';
                  } else {
                      status = 'Шах боту!';
                  }
              } else {
                  var moveColor = (game.turn() === playerColor) ? 'Вы' : 'Бот';
                  status = 'Ход: ' + moveColor;
              }
          }
          statusDiv.innerHTML = '<h3>' + status + '</h3>';

          if (game.game_over()) {
              var rematchButton = document.createElement('button');
              rematchButton.innerText = 'Реванш';
              rematchButton.onclick = function() {
                  game.reset();
                  board.start();
                  updateStatus();
                  calculateMaterialAdvantage();
                  if (playerColor === 'b') {
                      setTimeout(makeBotMove, 250);
                  }
              };
              statusDiv.appendChild(rematchButton);
          }
      }

      function onDrop(source, target) {
          var move = game.move({
              from: source,
              to: target,
              promotion: 'q'
          });

          if (move === null) return 'snapback';
          
          updateStatus();
          calculateMaterialAdvantage();
          if ((playerColor === 'w' && game.turn() === 'b') || (playerColor === 'b' && game.turn() === 'w')) {
            window.setTimeout(makeBotMove, 250);
          }
      }

      function makeBotMove() {
          if (game.game_over()) return;
          stockfish.postMessage('position fen ' + game.fen());
          stockfish.postMessage('go depth 10');

          stockfish.onmessage = function(event) {
              var message = event.data;
              if (message.startsWith('bestmove')) {
                  var bestMove = message.split(' ')[1];
                  game.move(bestMove, { sloppy: true });
                  board.position(game.fen());
                  updateStatus();
                  calculateMaterialAdvantage();
              }
          };
      }

      function startGame(color) {
          playerColor = color;
          document.getElementById('player-choice').style.display = 'none';
          gameArea.style.display = 'flex';
          
          var config = {
              draggable: true,
              position: 'start',
              onDrop: onDrop
          };
          
          if (playerColor === 'b') {
              config.orientation = 'black';
              game.load('rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1');
              setTimeout(makeBotMove, 500);
          }

          board = Chessboard('board', config);
          updateStatus();
          calculateMaterialAdvantage();
      }

      whiteButton.onclick = function() { startGame('w'); };
      blackButton.onclick = function() { startGame('b'); };
    </script>
</body>
</html>